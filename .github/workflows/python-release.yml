name: Python Wheels

on:
  push:
    tags:
      - 'python-v*'      # SemVer: python-v0.1.0
      - 'python-[0-9]*'  # CalVer: python-20260131-1
  pull_request:
    paths:
      - 'rust-code-analysis-python/**'
      - '.github/workflows/python-release.yml'
  workflow_dispatch:

permissions:
  contents: write

env:
  PYTHON_VERSIONS: "3.12 3.13 3.14"

jobs:
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: -m rust-code-analysis-python/Cargo.toml -o dist
      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  build-wheels-linux:
    name: Build Linux ${{ matrix.target }} wheels
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        env:
          # Fix C99 compilation for tree-sitter on cross-compile
          CFLAGS_aarch64_unknown_linux_gnu: "-std=gnu99"
        with:
          target: ${{ matrix.target }}
          manylinux: manylinux_2_34
          args: --release -m rust-code-analysis-python/Cargo.toml -o dist -i python3.12 -i python3.13 -i python3.14 -i python3.13t -i python3.14t

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist/*.whl

  build-wheels-macos:
    name: Build macOS ${{ matrix.target }} wheels
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-apple-darwin
          - aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release -m rust-code-analysis-python/Cargo.toml -o dist -i python3.12 -i python3.13 -i python3.13t -i python3.14 -i python3.14t
          sccache: 'true'

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist/*.whl

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build-sdist, build-wheels-linux, build-wheels-macos]
    if: startsWith(github.ref, 'refs/tags/python-')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List artifacts
        run: ls -la dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
          fail_on_unmatched_files: true
